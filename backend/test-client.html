<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Utilisateurs Anonymes - Socket.IO</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .user-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .user-info h3 {
            margin-bottom: 10px;
            color: #1976D2;
        }

        .user-info p {
            margin: 5px 0;
            color: #333;
        }

        .user-info strong {
            color: #1976D2;
        }

        .controls {
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .logs h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid #667eea;
        }

        .log-entry.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .log-entry.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .log-entry.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .log-entry.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .log-time {
            color: #6c757d;
            font-size: 11px;
            margin-right: 10px;
        }

        .users-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .instructions h4 {
            color: #856404;
            margin-bottom: 8px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin: 5px 0;
        }

        .room-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin: 5px 0;
        }

        .room-badge button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .room-badge button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Test Utilisateurs Anonymes</h1>
        <p class="subtitle">Socket.IO avec persistance en m√©moire</p>

        <div id="status" class="status disconnected">
            ‚ùå D√©connect√©
        </div>

        <div class="instructions">
            <h4>üí° Instructions de test :</h4>
            <ul>
                <li>Actualisez la page (F5) - vous gardez votre userId</li>
                <li>Ouvrez plusieurs onglets - chaque onglet a son propre userId</li>
                <li>Changez votre nom d'utilisateur</li>
                <li>Fermez et rouvrez votre navigateur - votre userId persiste (localStorage)</li>
            </ul>
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <h3>üë§ Vos informations</h3>
            <p><strong>User ID:</strong> <span id="userId">-</span></p>
            <p><strong>Username:</strong> <span id="username">-</span></p>
            <p><strong>Connect√© depuis:</strong> <span id="connectedAt">-</span></p>
            <p><strong>Utilisateurs en ligne:</strong> <span class="users-count" id="usersCount">0</span></p>
        </div>

        <div class="controls">
            <h3>üéÆ Contr√¥les</h3>
            <div class="input-group">
                <input type="text" id="newUsername" placeholder="Nouveau nom d'utilisateur">
                <button onclick="changeUsername()">Changer de nom</button>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="√âcrire un message">
                <button onclick="sendMessage()" class="secondary">Envoyer</button>
            </div>
            <div class="input-group">
                <input type="text" id="roomIdInput" placeholder="ID de la room">
                <button onclick="createRoom()">‚ûï Cr√©er une room</button>
                <button onclick="joinRoom()" class="secondary">üö™ Rejoindre une room</button>
            </div>
            <div id="currentRooms" style="margin-top: 15px;">
                <h4 style="margin-bottom: 10px; color: #333;">üè† Rooms actuelles:</h4>
                <div id="roomsList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <button onclick="clearUserId()" class="danger">üóëÔ∏è Effacer userId (simuler nouveau navigateur)</button>
                <button onclick="reconnect()">üîÑ Reconnecter</button>
            </div>
        </div>

        <div class="logs">
            <h3>üìã Journal des √©v√©nements</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let socket;
        let currentUserId = null;
        let currentUsername = null;
        let currentRooms = new Set(); // Set pour stocker les rooms actuelles

        // R√©cup√©rer le userId stock√© dans localStorage (si existe)
        const storedUserId = localStorage.getItem('anonymousUserId');
        
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString('fr-FR');
            entry.innerHTML = `<span class="log-time">${time}</span>${message}`;
            
            logsDiv.insertBefore(entry, logsDiv.firstChild);
            
            // Limiter √† 50 entr√©es
            while (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = '‚úÖ Connect√©';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = '‚ùå D√©connect√©';
            }
        }

        function updateUserInfo(data) {
            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.style.display = 'block';
            
            document.getElementById('userId').textContent = data.userId;
            document.getElementById('username').textContent = data.username;
            
            const connectedDate = new Date(data.connectedAt);
            document.getElementById('connectedAt').textContent = connectedDate.toLocaleString('fr-FR');
            
            currentUserId = data.userId;
            currentUsername = data.username;
        }

        function connectSocket() {
            // Connexion avec authentification (userId si existe)
            socket = io('http://localhost:3000', {
                auth: {
                    userId: storedUserId || null,
                    username: null // Peut √™tre d√©fini si vous voulez un nom initial
                }
            });

            // √âv√©nement : connexion r√©ussie
            socket.on('connect', () => {
                addLog(`üîå Connect√© au serveur (Socket ID: ${socket.id})`, 'success');
                updateStatus(true);
            });

            // √âv√©nement : utilisateur enregistr√©/reconnu
            socket.on('user-registered', (data) => {
                addLog(`üë§ Utilisateur enregistr√©: ${data.username} (${data.userId})`, 'success');
                
                // Sauvegarder le userId dans localStorage pour les reconnexions
                localStorage.setItem('anonymousUserId', data.userId);
                
                updateUserInfo(data);
            });

            // √âv√©nement : nom d'utilisateur mis √† jour
            socket.on('username-updated', (data) => {
                addLog(`‚úèÔ∏è Nom d'utilisateur chang√© en: ${data.username}`, 'info');
                currentUsername = data.username;
                document.getElementById('username').textContent = data.username;
            });

            // √âv√©nement : nombre d'utilisateurs connect√©s
            socket.on('users-count', (data) => {
                document.getElementById('usersCount').textContent = data.count;
                addLog(`üë• Nombre d'utilisateurs en ligne: ${data.count}`, 'info');
            });

            // √âv√©nement : message re√ßu
            socket.on('message', (data) => {
                addLog(`üí¨ Message re√ßu: ${data.text}`, 'info');
            });

            // √âv√©nement : utilisateur a rejoint la room
            socket.on('user-joined', (data) => {
                addLog(`üëã ${data.username || 'Un utilisateur'} a rejoint la room`, 'info');
            });

            // √âv√©nement : utilisateur a quitt√© la room
            socket.on('user-left', (data) => {
                addLog(`üëã ${data.username || 'Un utilisateur'} a quitt√© la room`, 'info');
            });

            // √âv√©nement : confirmation de jointure √† une room
            socket.on('room-joined', (data) => {
                if (data && data.roomId) {
                    currentRooms.add(data.roomId);
                    updateRoomsList();
                    addLog(`‚úÖ Vous avez rejoint la room: ${data.roomId}`, 'success');
                }
            });

            // √âv√©nement : confirmation de sortie d'une room
            socket.on('room-left', (data) => {
                if (data && data.roomId) {
                    currentRooms.delete(data.roomId);
                    updateRoomsList();
                    addLog(`üö™ Vous avez quitt√© la room: ${data.roomId}`, 'info');
                }
            });

            // √âv√©nement : d√©connexion
            socket.on('disconnect', (reason) => {
                addLog(`üîå D√©connect√© du serveur (Raison: ${reason})`, 'error');
                updateStatus(false);
                currentRooms.clear();
                updateRoomsList();
            });

            // √âv√©nement : erreur de connexion
            socket.on('connect_error', (error) => {
                addLog(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                updateStatus(false);
            });
        }

        function changeUsername() {
            const newUsername = document.getElementById('newUsername').value.trim();
            if (!newUsername) {
                alert('Veuillez entrer un nom d\'utilisateur');
                return;
            }

            socket.emit('change-username', newUsername);
            document.getElementById('newUsername').value = '';
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('Veuillez entrer un message');
                return;
            }

            socket.emit('message', { text: message });
            addLog(`üì§ Message envoy√©: ${message}`, 'warning');
            document.getElementById('messageInput').value = '';
        }

        function clearUserId() {
            if (confirm('Voulez-vous vraiment effacer votre userId ? Cela simulera un nouveau navigateur.')) {
                localStorage.removeItem('anonymousUserId');
                addLog('üóëÔ∏è userId effac√© du localStorage', 'warning');
                alert('Actualisez la page pour cr√©er un nouvel utilisateur');
            }
        }

        function reconnect() {
            if (socket) {
                socket.disconnect();
                addLog('üîÑ Reconnexion...', 'info');
                currentRooms.clear();
                updateRoomsList();
                setTimeout(() => {
                    connectSocket();
                }, 500);
            }
        }

        function generateRoomId() {
            // G√©n√®re un ID de room al√©atoire (6 caract√®res alphanum√©riques)
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function createRoom() {
            if (!socket || !socket.connected) {
                alert('Vous devez √™tre connect√© pour cr√©er une room');
                return;
            }

            const roomIdInput = document.getElementById('roomIdInput');
            let roomId = roomIdInput.value.trim();

            // Si aucun ID n'est fourni, g√©n√©rer un ID al√©atoire
            if (!roomId) {
                roomId = generateRoomId();
                roomIdInput.value = roomId;
            }

            // V√©rifier si l'utilisateur n'est pas d√©j√† dans cette room
            if (currentRooms.has(roomId)) {
                addLog(`‚ö†Ô∏è Vous √™tes d√©j√† dans la room: ${roomId}`, 'warning');
                return;
            }

            socket.emit('join-room', roomId);
            addLog(`üì§ Demande de cr√©ation/rejoint de la room: ${roomId}`, 'info');
        }

        function joinRoom() {
            if (!socket || !socket.connected) {
                alert('Vous devez √™tre connect√© pour rejoindre une room');
                return;
            }

            const roomIdInput = document.getElementById('roomIdInput');
            const roomId = roomIdInput.value.trim();

            if (!roomId) {
                alert('Veuillez entrer un ID de room');
                return;
            }

            // V√©rifier si l'utilisateur n'est pas d√©j√† dans cette room
            if (currentRooms.has(roomId)) {
                addLog(`‚ö†Ô∏è Vous √™tes d√©j√† dans la room: ${roomId}`, 'warning');
                return;
            }

            socket.emit('join-room', roomId);
            addLog(`üì§ Demande de jointure √† la room: ${roomId}`, 'info');
        }

        function leaveRoom(roomId) {
            if (!socket || !socket.connected) {
                alert('Vous devez √™tre connect√© pour quitter une room');
                return;
            }

            if (!currentRooms.has(roomId)) {
                addLog(`‚ö†Ô∏è Vous n'√™tes pas dans la room: ${roomId}`, 'warning');
                return;
            }

            socket.emit('leave-room', roomId);
            addLog(`üì§ Demande de sortie de la room: ${roomId}`, 'info');
        }

        function updateRoomsList() {
            const roomsListDiv = document.getElementById('roomsList');
            roomsListDiv.innerHTML = '';

            if (currentRooms.size === 0) {
                roomsListDiv.innerHTML = '<p style="color: #666; font-style: italic;">Aucune room active</p>';
                return;
            }

            currentRooms.forEach(roomId => {
                const roomBadge = document.createElement('div');
                roomBadge.className = 'room-badge';
                roomBadge.innerHTML = `
                    <span>üè† ${roomId}</span>
                    <button onclick="leaveRoom('${roomId}')" title="Quitter cette room">‚úï</button>
                `;
                roomsListDiv.appendChild(roomBadge);
            });
        }

        // Permettre l'envoi avec Entr√©e
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('newUsername').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                changeUsername();
            }
        });

        document.getElementById('roomIdInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const roomId = document.getElementById('roomIdInput').value.trim();
                if (roomId) {
                    if (currentRooms.has(roomId)) {
                        leaveRoom(roomId);
                    } else {
                        joinRoom();
                    }
                } else {
                    createRoom();
                }
            }
        });

        // Connexion automatique au chargement
        window.addEventListener('load', () => {
            if (storedUserId) {
                addLog(`üîç userId trouv√© dans localStorage: ${storedUserId}`, 'info');
            } else {
                addLog('üÜï Aucun userId trouv√©, cr√©ation d\'un nouvel utilisateur', 'info');
            }
            
            // Initialiser la liste des rooms
            updateRoomsList();
            
            connectSocket();
        });
    </script>
</body>
</html>

